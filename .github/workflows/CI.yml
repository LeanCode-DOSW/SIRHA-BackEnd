name: Java CI with Maven and JaCoCo

on:
  push:
    branches: [develop]
  pull_request:
    branches: [develop]

env:
  JAVA_VERSION: '17'
  JACOCO_MIN_COVERAGE: '0.80' 

jobs:
  test-and-coverage:
    name: Run Tests and Coverage
    runs-on: ubuntu-latest
    
    steps:

    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: 'maven'

    - name: Build with Maven
      run: |
        echo "üî® Compilando el proyecto..."
        mvn -B clean compile -q

    - name: Run unit tests with JaCoCo
      run: |
        echo "üß™ Ejecutando pruebas unitarias..."
        mvn -B test -DskipTests=false
      env:
        SPRING_PROFILES_ACTIVE: test


    - name: Generate JaCoCo report
      run: |
        echo "üìä Generando reporte de cobertura..."
        mvn -B jacoco:report

    - name: Check coverage thresholds
      run: |
        echo "‚úÖ Verificando cobertura m√≠nima del ${{ env.JACOCO_MIN_COVERAGE }}%..."
        mvn -B jacoco:check
      continue-on-error: false 

    - name: Display coverage summary
      run: |
        echo "üìà RESUMEN DE COBERTURA:"
        if [ -f target/site/jacoco/jacoco.xml ]; then
          # Extraer informaci√≥n b√°sica del reporte XML
          echo "Reporte JaCoCo generado en: target/site/jacoco/"
          echo "Para ver el reporte completo, descarga el artifact abajo ‚Üì"
        else
          echo "‚ùå No se pudo generar el reporte de cobertura"
          exit 1
        fi

    - name: Upload JaCoCo HTML report
      uses: actions/upload-artifact@v4
      with:
        name: jacoco-coverage-report
        path: target/site/jacoco/
        retention-days: 7

    - name: Upload JaCoCo XML report
      uses: actions/upload-artifact@v4
      with:
        name: jacoco-xml-report
        path: target/site/jacoco/jacoco.xml
        retention-days: 7

    - name: Publish coverage report to PR
      uses: actions/upload-artifact@v4
      with:
        name: coverage-pr-report
        path: |
          target/site/jacoco/index.html
          target/site/jacoco/jacoco.csv
        retention-days: 3