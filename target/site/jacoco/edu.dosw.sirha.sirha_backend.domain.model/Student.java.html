<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Student.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">SIRHA-BackEnd</a> &gt; <a href="index.source.html" class="el_package">edu.dosw.sirha.sirha_backend.domain.model</a> &gt; <span class="el_source">Student.java</span></div><h1>Student.java</h1><pre class="source lang-java linenums">package edu.dosw.sirha.sirha_backend.domain.model;
 
import java.util.List;
import java.util.Map;
import java.util.ArrayList;
import java.util.EnumMap;
import java.util.Objects;

import org.springframework.data.mongodb.core.mapping.Document;

import edu.dosw.sirha.sirha_backend.domain.model.enums.Careers;
import edu.dosw.sirha.sirha_backend.domain.model.enums.RequestStateEnum;
import edu.dosw.sirha.sirha_backend.domain.model.enums.SemaforoColores;
import edu.dosw.sirha.sirha_backend.domain.model.stategroup.Group;
import edu.dosw.sirha.sirha_backend.domain.model.staterequest.BaseRequest;
import edu.dosw.sirha.sirha_backend.domain.model.statesubjectdec.SubjectDecorator;
import edu.dosw.sirha.sirha_backend.domain.port.AcademicOperations;
import edu.dosw.sirha.sirha_backend.domain.port.AcademicProgress;
import edu.dosw.sirha.sirha_backend.domain.port.AcademicProgressViewer;
import edu.dosw.sirha.sirha_backend.domain.port.ScheduleManager;
import edu.dosw.sirha.sirha_backend.domain.port.SolicitudFactory;
import edu.dosw.sirha.sirha_backend.dto.AcademicIndicatorsDTO;
import edu.dosw.sirha.sirha_backend.dto.RequestApprovalRateDTO;
import edu.dosw.sirha.sirha_backend.dto.StudentDTO;
import edu.dosw.sirha.sirha_backend.dto.StudentReportDTO;
import edu.dosw.sirha.sirha_backend.dto.SubjectDecoratorDTO;
import edu.dosw.sirha.sirha_backend.exception.ErrorCodeSirha;
import edu.dosw.sirha.sirha_backend.exception.SirhaException;

/**
 * Entidad del dominio que representa a un estudiante en el sistema SIRHA.
 *
 * Esta clase extiende de User y añade funcionalidades específicas para estudiantes,
 * incluyendo gestión de código estudiantil, plan de estudios, semáforo académico
 * y solicitudes realizadas.
 *
 * El estudiante es la entidad central del sistema, ya que todas las operaciones
 * principales (inscripciones, cambios de grupo, solicitudes) se realizan en
 * torno a esta entidad.
 *
 */
@Document(collection = &quot;students&quot;)
public class Student extends User implements SolicitudFactory, ScheduleManager, AcademicProgressViewer, AcademicOperations {
    private String codigo;
    private AcademicProgress academicProgress;
    private List&lt;BaseRequest&gt; solicitudes;
    
 
<span class="nc" id="L49">    public Student() {</span>
<span class="nc" id="L50">        solicitudes = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L51">    }</span>

    public Student(String id, String username, String email, String passwordHash, String codigo) throws SirhaException {
<span class="fc" id="L54">        super(id, username, email, passwordHash);</span>
<span class="fc" id="L55">        this.codigo = codigo;</span>
<span class="fc" id="L56">        solicitudes = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L57">    }</span>

    /**
     * Constructor principal para crear un nuevo estudiante.
     * 
     * Inicializa un estudiante con los datos básicos requeridos.
     * La lista de solicitudes se inicializa como lista vacía.
     * El plan de estudios y semáforo deben ser asignados posteriormente.
     */
    public Student(String username, String email, String passwordHash, String codigo) throws SirhaException {
<span class="fc" id="L67">        super(username, email, passwordHash);</span>
<span class="fc" id="L68">        this.codigo = codigo;</span>
<span class="fc" id="L69">        solicitudes = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L70">    }</span>

    /**
     * Agrega una nueva solicitud a la lista del estudiante.
     * 
     * Añade una solicitud académica (cambio de grupo, cambio de materia, etc.)
     * a la lista de solicitudes del estudiante. La solicitud debe estar
     * completamente inicializada antes de agregarla.
     */
    public void addRequest(BaseRequest solicitud) throws SirhaException {
<span class="pc bpc" id="L80" title="1 of 2 branches missed.">        if (solicitud == null) {</span>
<span class="nc" id="L81">            throw SirhaException.of(ErrorCodeSirha.REQUEST_NOT_FOUND, &quot;La solicitud no puede ser null&quot;);</span>
        }
        
<span class="pc bpc" id="L84" title="1 of 2 branches missed.">        if (this.solicitudes == null) {</span>
<span class="nc" id="L85">            this.solicitudes = new ArrayList&lt;&gt;();</span>
        }
        
<span class="fc" id="L88">        this.solicitudes.add(solicitud);</span>
<span class="fc" id="L89">    }</span>

    public void removeRequest(BaseRequest solicitud) throws SirhaException {
<span class="nc bnc" id="L92" title="All 2 branches missed.">        if (solicitud == null) {</span>
<span class="nc" id="L93">            throw SirhaException.of(ErrorCodeSirha.REQUEST_NOT_FOUND, &quot;La solicitud no puede ser null&quot;);</span>
        }

<span class="nc bnc" id="L96" title="All 4 branches missed.">        if (this.solicitudes == null || !this.solicitudes.contains(solicitud)) {</span>
<span class="nc" id="L97">            throw SirhaException.of(ErrorCodeSirha.REQUEST_NOT_FOUND, &quot;La solicitud no existe en la lista del estudiante&quot;);</span>
        }

<span class="nc" id="L100">        this.solicitudes.remove(solicitud);</span>
<span class="nc" id="L101">    }</span>

    /**
     * Obtiene el código estudiantil.
     * @return código único del estudiante
     */
    public String getCodigo() {
<span class="fc" id="L108">        return codigo;</span>
    }
 
    /**
     * Establece el código estudiantil.
     * @param codigo nuevo código del estudiante. No debe ser null o vacío.
     * @throws SirhaException 
     * @throws IllegalStateException si el código es null o vacío
     */
    public void setCodigo(String codigo) throws SirhaException {
<span class="pc bpc" id="L118" title="2 of 4 branches missed.">        if (codigo == null || codigo.trim().isEmpty()) {</span>
<span class="nc" id="L119">            throw SirhaException.of(ErrorCodeSirha.INVALID_ARGUMENT, &quot;El código no puede ser null o vacío&quot;);</span>
        }
<span class="fc" id="L121">        this.codigo = codigo;</span>
<span class="fc" id="L122">    }</span>
 
    /**
     * Obtiene el plan de estudios asignado.
     * @return plan de estudios del estudiante, puede ser null si no se ha asignado
     */
    public StudyPlan getPlanGeneral() {
<span class="fc" id="L129">        return academicProgress.getStudyPlan();</span>
    }
 
 

    public AcademicProgress getAcademicProgress() {
<span class="fc" id="L135">        return academicProgress;</span>
    }
    
    public void setAcademicProgress(AcademicProgress academicProgress) {
<span class="fc" id="L139">        this.academicProgress = academicProgress;</span>
<span class="fc" id="L140">    }</span>
    

    /**
     * Obtiene la lista de solicitudes del estudiante.
     * @return lista de solicitudes, nunca null (inicializada como lista vacía)
     */
    public List&lt;BaseRequest&gt; getSolicitudes() {
<span class="pc bpc" id="L148" title="1 of 2 branches missed.">        if (solicitudes == null) {</span>
<span class="nc" id="L149">            solicitudes = new ArrayList&lt;&gt;();</span>
        }
<span class="fc" id="L151">        return new ArrayList&lt;&gt;(solicitudes);</span>
    }
    
    @Override
    public Careers getCareer() {
<span class="fc bfc" id="L156" title="All 2 branches covered.">        if (academicProgress == null) {</span>
<span class="fc" id="L157">            return Careers.DEFAULT;</span>
        }
<span class="fc" id="L159">        return academicProgress.getCareer();</span>
    }
    
 
    /**
     * Compara este estudiante con otro objeto para determinar igualdad.
     * Dos estudiantes son iguales si tienen el mismo código.
     *
     * @param obj objeto a comparar
     * @return true si los objetos son iguales, false en caso contrario
     */
    @Override
    public boolean equals(Object obj) {
<span class="fc bfc" id="L172" title="All 2 branches covered.">        if (this == obj) return true;</span>
<span class="pc bpc" id="L173" title="2 of 4 branches missed.">        if (obj == null || getClass() != obj.getClass()) return false;</span>
<span class="pc bpc" id="L174" title="1 of 2 branches missed.">        if (!super.equals(obj)) return false;</span>
       
<span class="nc" id="L176">        Student student = (Student) obj;</span>
<span class="nc" id="L177">        return Objects.equals(codigo, student.codigo);</span>
    }

    @Override
    public int hashCode() {
<span class="nc" id="L182">        return Objects.hash(super.hashCode(), codigo);</span>
    }
    
    public List&lt;SubjectDecorator&gt; getSubjectsInProgress() {
<span class="fc bfc" id="L186" title="All 2 branches covered.">        if (this.academicProgress == null) {</span>
<span class="fc" id="L187">            return new ArrayList&lt;&gt;();</span>
        }
<span class="fc" id="L189">        return academicProgress.getSubjectsInProgress();</span>
    }
    public int getTotalSubjectsCount() {
<span class="pc bpc" id="L192" title="1 of 2 branches missed.">        if (academicProgress == null) {</span>
<span class="nc" id="L193">            return 0;</span>
        }
<span class="fc" id="L195">        return academicProgress.getTotalSubjectsCount();</span>
    }
    public int getSubjectsInProgressCount() {
<span class="fc bfc" id="L198" title="All 2 branches covered.">        if (academicProgress == null) {</span>
<span class="fc" id="L199">            return 0;</span>
        }
<span class="fc" id="L201">        return academicProgress.getSubjectsInProgressCount();</span>
    }
    
    public int getPassedSubjectsCount() {
<span class="fc bfc" id="L205" title="All 2 branches covered.">        if (academicProgress == null) {</span>
<span class="fc" id="L206">            return 0;</span>
        }
<span class="fc" id="L208">        return academicProgress.getPassedSubjectsCount();</span>
    }
   
    public int getFailedSubjectsCount() {
<span class="fc bfc" id="L212" title="All 2 branches covered.">        if (academicProgress == null) {</span>
<span class="fc" id="L213">            return 0;</span>
        }
<span class="fc" id="L215">        return academicProgress.getFailedSubjectsCount();</span>
    }
    
    public int getSubjectsNotTakenCount() {
<span class="fc bfc" id="L219" title="All 2 branches covered.">        if (academicProgress == null) {</span>
<span class="fc" id="L220">            return 0;</span>
        }
<span class="fc" id="L222">        return academicProgress.getSubjectsNotTakenCount();</span>
    }
    
    /**
     * Obtiene las materias de un semestre específico.
     *
     * @param semestre el semestre a consultar
     * @return lista de materias del semestre
     */
    public List&lt;SubjectDecorator&gt; getSubjectsBySemester(int semestre) {
<span class="fc bfc" id="L232" title="All 2 branches covered.">        if (this.academicProgress == null) {</span>
<span class="fc" id="L233">            return new ArrayList&lt;&gt;();</span>
        }
<span class="fc" id="L235">        return academicProgress.getSubjectsBySemester(semestre);</span>
    }
 
    /**
     * Calcula el total de créditos por estado del semáforo.
     *
     * @param color el color del semáforo a filtrar
     * @return total de créditos
     */
    public int getCreditsByColor(SemaforoColores color) {
<span class="fc bfc" id="L245" title="All 2 branches covered.">        if (academicProgress == null) {</span>
<span class="fc" id="L246">            return 0;</span>
        }
<span class="fc" id="L248">        return academicProgress.getCreditsByColor(color);</span>
    }
 
   
    
 
 
    public boolean hasScheduleConflictWith(Group nuevoGrupo) {
<span class="pc bpc" id="L256" title="1 of 4 branches missed.">        if (nuevoGrupo == null || academicProgress == null) {</span>
<span class="fc" id="L257">            return false;</span>
        }

<span class="fc" id="L260">        return getSubjectsInProgress().stream()</span>
<span class="pc bpc" id="L261" title="1 of 2 branches missed.">            .filter(materia -&gt; materia.getGroup() != null)</span>
<span class="fc" id="L262">            .anyMatch(materia -&gt; materia.getGroup().conflictoConHorario(nuevoGrupo));</span>
    }
    
    
    /**
     * Obtiene los horarios de las materias en curso (materias amarillas).
     * 
     * @return lista de horarios de Schedule
     */
    public List&lt;Schedule&gt; getCurrentSchedule() {
<span class="pc bpc" id="L272" title="1 of 2 branches missed.">        if (academicProgress == null) {</span>
<span class="fc" id="L273">            return new ArrayList&lt;&gt;();</span>
        }
<span class="nc" id="L275">        return getSubjectsInProgress().stream()</span>
<span class="nc bnc" id="L276" title="All 2 branches missed.">            .filter(materia -&gt; materia.getGroup() != null)</span>
<span class="nc" id="L277">            .flatMap(materia -&gt; materia.getGroup().getSchedules().stream())</span>
<span class="nc" id="L278">            .toList();</span>
    }
    
    /**
     * Verifica si el estudiante tiene alguna materia inscrita en el semestre actual.
     * 
     * @return true si tiene materias cursando, false en caso contrario
     */
    public boolean hasCoursesInProgress() {
<span class="fc bfc" id="L287" title="All 2 branches covered.">        return getSubjectsInProgressCount() &gt; 0;</span>
    }
    
    /**
     * Obtiene el total de créditos que está cursando actualmente.
     * 
     * @return total de créditos en curso
     */
    public int getCreditsInProgress() {
<span class="pc bpc" id="L296" title="1 of 2 branches missed.">        if (academicProgress == null) {</span>
<span class="fc" id="L297">            return 0;</span>
        }
<span class="nc" id="L299">        return getCreditsByColor(SemaforoColores.AMARILLO);</span>
    }
    
    /**
     * Obtiene el semestre académico actual basado en las materias en curso.
     * 
     * @return semestre actual calculado
     */
    public int getCurrentSemester() {
<span class="fc" id="L308">        List&lt;SubjectDecorator&gt; cursando = getSubjectsInProgress();</span>
<span class="pc bpc" id="L309" title="1 of 2 branches missed.">        if (cursando.isEmpty()) {</span>
<span class="fc" id="L310">            return 1; // Si no tiene materias en curso, asume primer semestre</span>
        }
        
<span class="nc" id="L313">        double promedioSemestre = cursando.stream()</span>
<span class="nc" id="L314">            .mapToInt(SubjectDecorator::getSemester)</span>
<span class="nc bnc" id="L315" title="All 2 branches missed.">            .filter(s -&gt; s &gt; 0)</span>
<span class="nc" id="L316">            .average()</span>
<span class="nc" id="L317">            .orElse(1.0);</span>
            
<span class="nc" id="L319">        return (int) Math.ceil(promedioSemestre);</span>
    }


    public AcademicPeriod getCurrentPeriod() {
<span class="fc bfc" id="L324" title="All 2 branches covered.">        if (academicProgress == null) {</span>
<span class="fc" id="L325">            return null;</span>
        }
<span class="fc" id="L327">        return academicProgress.getCurrentAcademicPeriod();</span>
    }
    public void setCurrentPeriod(AcademicPeriod currentPeriod) throws SirhaException {
<span class="pc bpc" id="L330" title="1 of 2 branches missed.">        if (academicProgress == null) {</span>
<span class="nc" id="L331">            throw SirhaException.of(ErrorCodeSirha.INVALID_ARGUMENT, &quot;El progreso académico no está inicializado&quot;);</span>
        }
<span class="pc bpc" id="L333" title="1 of 2 branches missed.">        if (!academicProgress.getSubjectsInProgress().isEmpty()) {</span>
<span class="nc" id="L334">            throw SirhaException.of(ErrorCodeSirha.OPERATION_NOT_ALLOWED, &quot;No se puede cambiar el período académico mientras hay materias en curso&quot;);</span>
        }
<span class="fc" id="L336">        academicProgress.setCurrentAcademicPeriod(currentPeriod);</span>
<span class="fc" id="L337">    }</span>

    public boolean hasSubject(SubjectDecorator subject) {
<span class="nc bnc" id="L340" title="All 4 branches missed.">        if (subject == null || academicProgress == null) {</span>
<span class="nc" id="L341">            return false;</span>
        }
<span class="nc" id="L343">        return hasSubject(subject.getSubject());</span>
    }

    public boolean canEnroll(Subject subject) throws SirhaException {
        // 1. Verificar que la materia esté en el plan de estudios
<span class="pc bpc" id="L348" title="2 of 4 branches missed.">        if (academicProgress.getStudyPlan() == null || !academicProgress.getStudyPlan().hasSubject(subject)) {</span>
<span class="nc" id="L349">            throw SirhaException.of(ErrorCodeSirha.INVALID_ARGUMENT, &quot;La materia no está en el plan de estudios del estudiante&quot;);</span>
        }
        
        // 2. Verificar que la materia no esté ya inscrita

<span class="pc bpc" id="L354" title="1 of 2 branches missed.">        if (!academicProgress.isSubjectNoCursada(subject)) {</span>
<span class="nc" id="L355">            throw SirhaException.of(ErrorCodeSirha.OPERATION_NOT_ALLOWED, &quot;La materia ya está inscrita&quot;);</span>
        }
        
        // 3. Verificar prerrequisitos
<span class="fc bfc" id="L359" title="All 4 branches covered.">        if (subject.hasPrerequisites() &amp;&amp; !subject.canEnroll(academicProgress)) {</span>
<span class="fc" id="L360">            throw SirhaException.of(ErrorCodeSirha.OPERATION_NOT_ALLOWED, &quot;No se cumplen los prerrequisitos para inscribir la materia&quot;);</span>
            }
        
<span class="fc" id="L363">        return true;</span>
    }
    
    public boolean canEnrollInGroup(Subject subject, Group group) throws SirhaException {
        // Primero verificar las validaciones básicas de la materia
<span class="pc bpc" id="L368" title="1 of 2 branches missed.">        if (!canEnroll(subject)) {</span>
<span class="nc" id="L369">            throw SirhaException.of(ErrorCodeSirha.OPERATION_NOT_ALLOWED, &quot;La materia no se puede inscribir&quot;);</span>
        }
        
        // 4. Verificar que el grupo esté abierto
<span class="pc bpc" id="L373" title="1 of 2 branches missed.">        if (!group.isOpen()) {</span>
<span class="nc" id="L374">            throw SirhaException.of(ErrorCodeSirha.GROUP_CLOSED, &quot;El grupo está cerrado&quot;);</span>
        }
        
        // 6. Verificar período académico activo
<span class="fc" id="L378">        AcademicPeriod currentPeriod = getCurrentPeriod();</span>
<span class="pc bpc" id="L379" title="3 of 6 branches missed.">        if (currentPeriod == null || !currentPeriod.isActive() || !group.sameAcademicPeriod(currentPeriod)) {</span>
<span class="nc" id="L380">            throw SirhaException.of(ErrorCodeSirha.ACADEMIC_PERIOD_NOT_VALID, &quot;El período académico no es válido&quot;);</span>
        }
        
        // 7. Verificar conflicto de horarios
<span class="pc bpc" id="L384" title="1 of 2 branches missed.">        if (hasScheduleConflictWith(group)) {</span>
<span class="nc" id="L385">            throw SirhaException.of(ErrorCodeSirha.SCHEDULE_CONFLICT, &quot;Conflicto de horarios detectado&quot;);</span>
        }
        
        // 9. Verificar límite de créditos por semestre FALTA IMPLEMENTAR AAAAAAAAAAAAAAAAAAA

<span class="fc" id="L390">        return true;</span>
    }

    public void enrollSubject(Subject subject, Group group) throws SirhaException {
<span class="pc bpc" id="L394" title="1 of 2 branches missed.">        if (!canEnrollInGroup(subject, group)) {</span>
<span class="nc" id="L395">            throw SirhaException.of(ErrorCodeSirha.OPERATION_NOT_ALLOWED, &quot;No se puede inscribir en la materia o grupo especificado&quot;);</span>
        }
        
<span class="fc" id="L398">        group.enrollStudent(this);</span>
<span class="fc" id="L399">        academicProgress.enrollSubjectInGroup(subject, group);</span>

        //academicProgress.recordEnrollment(subject, group, currentPeriod); despues
<span class="fc" id="L402">    }</span>

    public void enrollSubject(Subject subject, Group group, int semester) throws SirhaException {
<span class="fc" id="L405">        enrollSubject(subject, group);</span>
<span class="fc" id="L406">        academicProgress.setSubjectSemester(subject.getName(), semester);</span>

<span class="fc" id="L408">    }</span>

    @Override
    public void unenrollSubject(Subject subject, Group group) throws SirhaException {
<span class="nc" id="L412">        AcademicPeriod currentPeriod = getCurrentPeriod();</span>
<span class="nc bnc" id="L413" title="All 6 branches missed.">        if (currentPeriod == null || !currentPeriod.isActive() || !group.sameAcademicPeriod(currentPeriod)) {</span>
<span class="nc" id="L414">            throw SirhaException.of(ErrorCodeSirha.ACADEMIC_PERIOD_NOT_VALID, &quot;El período académico no es válido para el grupo especificado&quot;);</span>
        }

<span class="nc" id="L417">        group.unenrollStudent(this);</span>
<span class="nc" id="L418">        academicProgress.unenrollSubjectFromGroup(subject.getName(), group);</span>
<span class="nc" id="L419">    }</span>

    @Override
    public void approveSubject(Subject subject) throws SirhaException {
<span class="fc" id="L423">        academicProgress.approveSubject(subject.getName());</span>
<span class="fc" id="L424">    }</span>

    @Override
    public void failSubject(Subject subject) throws SirhaException {
<span class="fc" id="L428">        academicProgress.failSubject(subject.getName());</span>
<span class="fc" id="L429">    }</span>

    /*
     * Verifica si el estudiante tiene una materia específica en su progreso académico.
     */
    public boolean hasSubject(Subject subject) {
<span class="fc bfc" id="L435" title="All 4 branches covered.">        return academicProgress != null &amp;&amp; academicProgress.hasSubject(subject);</span>
    }

    public boolean validateChangeGroup(Subject subject, Group newGroup) throws SirhaException {

<span class="fc bfc" id="L440" title="All 2 branches covered.">        if (!hasSubject(subject)) {</span>
<span class="fc" id="L441">            throw SirhaException.of(ErrorCodeSirha.SUBJECT_NOT_FOUND, &quot;El estudiante no tiene la materia especificada&quot;);</span>
        }
<span class="pc bpc" id="L443" title="1 of 2 branches missed.">        if (!academicProgress.isSubjectCursando(subject)) {</span>
<span class="nc" id="L444">            throw SirhaException.of(ErrorCodeSirha.SUBJECT_NOT_IN_PROGRESS, &quot;La materia no está en curso&quot;);</span>
        }

<span class="pc bpc" id="L447" title="1 of 2 branches missed.">        if (!academicProgress.verifyChangeGroup(subject, newGroup)) {</span>
<span class="nc" id="L448">            throw SirhaException.of(ErrorCodeSirha.INVALID_STATE_TRANSITION, &quot;No se puede cambiar al nuevo grupo especificado&quot;);</span>
        }
<span class="pc bpc" id="L450" title="1 of 2 branches missed.">        if (!subject.hasGroup(newGroup)) {</span>
<span class="nc" id="L451">            throw SirhaException.of(ErrorCodeSirha.INVALID_STATE_TRANSITION, &quot;El nuevo grupo no pertenece a la materia especificada&quot;);</span>
        }
<span class="fc bfc" id="L453" title="All 2 branches covered.">        if (!newGroup.isOpen()) {</span>
<span class="fc" id="L454">            throw SirhaException.of(ErrorCodeSirha.GROUP_CLOSED, &quot;El nuevo grupo está cerrado&quot;);</span>
        }
<span class="fc bfc" id="L456" title="All 2 branches covered.">        if (hasScheduleConflictWith(newGroup)) {</span>
<span class="fc" id="L457">            throw SirhaException.of(ErrorCodeSirha.SCHEDULE_CONFLICT, &quot;Conflicto de horarios con el nuevo grupo&quot;);</span>
        }
<span class="fc" id="L459">        AcademicPeriod currentPeriod = getCurrentPeriod();</span>
<span class="pc bpc" id="L460" title="2 of 6 branches missed.">        if (currentPeriod == null || !currentPeriod.isActive() || !newGroup.sameAcademicPeriod(currentPeriod)) {</span>
<span class="fc" id="L461">            throw SirhaException.of(ErrorCodeSirha.ACADEMIC_PERIOD_NOT_VALID, &quot;El período académico no es válido para el nuevo grupo&quot;);</span>
        }
<span class="fc" id="L463">        return true;</span>
    }

    public boolean validateChangeSubject(Subject oldSubject, Subject newSubject, Group newGroup) throws SirhaException {
<span class="fc bfc" id="L467" title="All 2 branches covered.">        if (!hasSubject(oldSubject)) {</span>
<span class="fc" id="L468">            throw SirhaException.of(ErrorCodeSirha.SUBJECT_NOT_FOUND, &quot;El estudiante no tiene la materia antigua especificada&quot;);</span>
        }
<span class="fc bfc" id="L470" title="All 2 branches covered.">        if (!academicProgress.isSubjectCursando(oldSubject)) {</span>
<span class="fc" id="L471">            throw SirhaException.of(ErrorCodeSirha.SUBJECT_NOT_IN_PROGRESS, &quot;La materia antigua no está en curso&quot;);</span>
        }
<span class="fc bfc" id="L473" title="All 2 branches covered.">        if (oldSubject.equals(newSubject)) {</span>
<span class="fc" id="L474">            throw SirhaException.of(ErrorCodeSirha.SAME_SUBJECT, &quot;La materia nueva es la misma que la antigua&quot;);</span>
        }
<span class="fc bfc" id="L476" title="All 4 branches covered.">        if (academicProgress.hasSubject(newSubject) &amp;&amp; !academicProgress.isSubjectNoCursada(newSubject)) {</span>
<span class="fc" id="L477">            throw SirhaException.of(ErrorCodeSirha.SUBJECT_ALREADY_ENROLLED, &quot;El estudiante ya tiene la materia nueva inscrita o aprobada&quot;);</span>
        }
<span class="fc bfc" id="L479" title="All 2 branches covered.">        if (!academicProgress.getStudyPlan().hasSubject(newSubject)) {</span>
<span class="fc" id="L480">            throw SirhaException.of(ErrorCodeSirha.SUBJECT_NOT_IN_STUDY_PLAN, &quot;La materia nueva no está en el plan de estudios del estudiante&quot;);</span>
        }
<span class="pc bpc" id="L482" title="1 of 4 branches missed.">        if (newSubject.hasPrerequisites() &amp;&amp; !newSubject.canEnroll(academicProgress)) {</span>
<span class="fc" id="L483">            throw SirhaException.of(ErrorCodeSirha.PREREQUISITES_NOT_MET, &quot;No se cumplen los prerrequisitos para inscribir la materia nueva&quot;);</span>
        }
<span class="fc bfc" id="L485" title="All 2 branches covered.">        if (!newSubject.hasGroup(newGroup)) {</span>
<span class="fc" id="L486">            throw SirhaException.of(ErrorCodeSirha.GROUP_NOT_FOUND, &quot;El nuevo grupo no pertenece a la materia nueva especificada&quot;);</span>
        }
<span class="fc bfc" id="L488" title="All 2 branches covered.">        if (!newGroup.isOpen()) {</span>
<span class="fc" id="L489">            throw SirhaException.of(ErrorCodeSirha.GROUP_CLOSED, &quot;El nuevo grupo está cerrado&quot;);</span>
        }
<span class="fc bfc" id="L491" title="All 2 branches covered.">        if (hasScheduleConflictWith(newGroup)) {</span>
<span class="fc" id="L492">            throw SirhaException.of(ErrorCodeSirha.SCHEDULE_CONFLICT, &quot;Conflicto de horarios con el nuevo grupo&quot;);</span>
        }
<span class="fc" id="L494">        AcademicPeriod currentPeriod = getCurrentPeriod();</span>
<span class="pc bpc" id="L495" title="2 of 6 branches missed.">        if (currentPeriod == null || !currentPeriod.isActive() || !newGroup.sameAcademicPeriod(currentPeriod)) {</span>
<span class="fc" id="L496">            throw SirhaException.of(ErrorCodeSirha.ACADEMIC_PERIOD_NOT_VALID, &quot;El período académico no es válido para el nuevo grupo&quot;);</span>
        }
<span class="fc" id="L498">        return true;</span>
    }

    public CambioGrupo createGroupChangeRequest(Subject subject, Group newGroup) throws SirhaException {
<span class="fc" id="L502">        validateChangeGroup(subject, newGroup);</span>
<span class="fc" id="L503">        CambioGrupo solicitud = new CambioGrupo(this, subject, newGroup, getCurrentPeriod());</span>
<span class="fc" id="L504">        addRequest(solicitud);</span>
<span class="fc" id="L505">        return solicitud;</span>
    }
    public CambioMateria createSubjectChangeRequest(Subject oldSubject, Subject newSubject, Group newGroup) throws SirhaException {
<span class="fc" id="L508">        validateChangeSubject(oldSubject, newSubject, newGroup) ;</span>
<span class="fc" id="L509">        CambioMateria solicitud = new CambioMateria(this, oldSubject, newSubject, newGroup, getCurrentPeriod());</span>
<span class="fc" id="L510">        addRequest(solicitud);</span>
<span class="fc" id="L511">        return solicitud;</span>
        
    }

    public Map&lt;AcademicPeriod, List&lt;Schedule&gt;&gt; getAllSchedules() {
<span class="pc bpc" id="L516" title="1 of 2 branches missed.">        if (academicProgress == null) {</span>
<span class="fc" id="L517">            return Map.of();</span>
            
        }
<span class="nc" id="L520">        return academicProgress.getAllSchedules();</span>
    }

    @Override
    public List&lt;Schedule&gt; getScheduleForPeriod(AcademicPeriod period) {
<span class="nc" id="L525">        return getAllSchedules().getOrDefault(period, new ArrayList&lt;&gt;());</span>
    }

    /**
     * Representación en string del estudiante.
     * @return string con información básica del estudiante
     */
    public String toString() {
<span class="fc" id="L533">        return String.format(&quot;Student{id='%s', username='%s', codigo='%s'}&quot;,</span>
<span class="fc" id="L534">                            getId(), getUsername(), codigo);</span>
    }

    @Override
    public Map&lt;SemaforoColores, List&lt;SubjectDecoratorDTO&gt;&gt; getAcademicPensum() {
<span class="fc bfc" id="L539" title="All 2 branches covered.">        if (academicProgress == null) {</span>
<span class="fc" id="L540">            return Map.of(</span>
<span class="fc" id="L541">                SemaforoColores.VERDE, new ArrayList&lt;&gt;(),</span>
<span class="fc" id="L542">                SemaforoColores.AMARILLO, new ArrayList&lt;&gt;(),</span>
<span class="fc" id="L543">                SemaforoColores.ROJO, new ArrayList&lt;&gt;(),</span>
<span class="fc" id="L544">                SemaforoColores.GRIS, new ArrayList&lt;&gt;()</span>
            );
        }
<span class="fc" id="L547">        return academicProgress.getAcademicPensum();</span>
    }


    @Override
    public Map&lt;SemaforoColores, Double&gt; getPercentageByColor() {
<span class="fc bfc" id="L553" title="All 2 branches covered.">        if (academicProgress == null) {</span>
<span class="fc" id="L554">            return new EnumMap&lt;&gt;(SemaforoColores.class);</span>
        }
<span class="fc" id="L556">        return academicProgress.getPercentageByColor();</span>
    }

    @Override
    public StudentDTO getStudentBasicInfo() {
<span class="fc" id="L561">        return new StudentDTO(</span>
<span class="fc" id="L562">            getId(),</span>
<span class="fc" id="L563">            getUsername(),</span>
<span class="fc" id="L564">            getEmail(),</span>
<span class="fc" id="L565">            getCodigo(),</span>
<span class="fc" id="L566">            getCareer()</span>
        );
    }

    @Override
    public double getOverallProgressPercentage() {
<span class="fc bfc" id="L572" title="All 2 branches covered.">        if (academicProgress == null) {</span>
<span class="fc" id="L573">            return 0.0;</span>
        }
<span class="fc" id="L575">        return academicProgress.getOverallProgressPercentage();</span>
    }

    public double getAcademicSuccessRate(){
<span class="fc bfc" id="L579" title="All 2 branches covered.">        if (academicProgress == null) {</span>
<span class="fc" id="L580">            return 0.0;</span>
        }
<span class="fc" id="L582">        return academicProgress.getAcademicSuccessRate();</span>
    }
    public double getCompletedCreditsPercentage(){
<span class="fc bfc" id="L585" title="All 2 branches covered.">        if (academicProgress == null) {</span>
<span class="fc" id="L586">            return 0.0;</span>
        }
<span class="fc" id="L588">        return academicProgress.getCompletedCreditsPercentage();</span>
    }

    public AcademicIndicatorsDTO getAcademicIndicators(){
<span class="fc bfc" id="L592" title="All 2 branches covered.">        if (academicProgress == null) {</span>
<span class="fc" id="L593">            return null;</span>
        }
<span class="fc" id="L595">        return academicProgress.getAcademicIndicators();</span>
    }

    @Override
    public StudentReportDTO generateCompleteReport() {
<span class="pc bpc" id="L600" title="1 of 2 branches missed.">        if (academicProgress == null) {</span>
<span class="nc" id="L601">            return null;</span>
        }
<span class="fc" id="L603">        return new StudentReportDTO(</span>
<span class="fc" id="L604">            getStudentBasicInfo(),</span>
<span class="fc" id="L605">            getAcademicIndicators(),</span>
<span class="fc" id="L606">            getRequestApprovalRate()</span>
        );
    }

    /**
     * Obtiene un resumen del progreso académico del estudiante.
     *
     * @return string con el resumen
     */
    @Override
    public String getAcademicSummary() {
<span class="fc" id="L617">        int aprobadas = getPassedSubjectsCount();</span>
<span class="fc" id="L618">        int cursando = getSubjectsInProgressCount();</span>
<span class="fc" id="L619">        int reprobadas = getFailedSubjectsCount();</span>
<span class="fc" id="L620">        int noCursadas = getSubjectsNotTakenCount();</span>
<span class="fc" id="L621">        int creditosAprobados = getCreditsByColor(SemaforoColores.VERDE);</span>
<span class="fc" id="L622">        int creditosCursando = getCreditsByColor(SemaforoColores.AMARILLO);</span>
 
<span class="fc" id="L624">        return String.format(</span>
<span class="fc" id="L625">            &quot;Estudiante: %s del programa %s - Aprobadas: %d (%d créditos) | Cursando: %d (%d créditos) | Reprobadas: %d | No Cursadas: %d - Progreso: %.2f%%&quot;,</span>
<span class="fc" id="L626">            codigo, getCareer().getDisplayName(), aprobadas, creditosAprobados, cursando, creditosCursando, reprobadas, noCursadas, getOverallProgressPercentage()</span>
        );
    }

    @Override
    public double getApprovalRequestPercentage() {
<span class="pc bpc" id="L632" title="1 of 4 branches missed.">        if (solicitudes == null || solicitudes.isEmpty()) {</span>
<span class="fc" id="L633">            return 0.0;</span>
        }
<span class="fc" id="L635">        return getRequestApprovalRate().getApprovalRatePercentage();</span>
    }
    @Override
    public double getRejectionRequestPercentage(){
<span class="pc bpc" id="L639" title="1 of 4 branches missed.">        if (solicitudes == null || solicitudes.isEmpty()) {</span>
<span class="fc" id="L640">            return 0.0;</span>
        }
<span class="fc" id="L642">        return getRequestApprovalRate().getRejectionRatePercentage();</span>
    }
    @Override
    public double getPendingRequestPercentage(){
<span class="pc bpc" id="L646" title="1 of 4 branches missed.">        if (solicitudes == null || solicitudes.isEmpty()) {</span>
<span class="fc" id="L647">            return 0.0;</span>
        }
<span class="fc" id="L649">        return getRequestApprovalRate().getPendingRatePercentage();</span>
    }
    @Override
    public double getInReviewRequestPercentage(){
<span class="pc bpc" id="L653" title="2 of 4 branches missed.">        if (solicitudes == null || solicitudes.isEmpty()) {</span>
<span class="nc" id="L654">            return 0.0;</span>
        }
<span class="fc" id="L656">        return getRequestApprovalRate().getInReviewRatePercentage();</span>
    }

    @Override
    public int getTotalRequestsMade(){
<span class="pc bpc" id="L661" title="1 of 2 branches missed.">        if (solicitudes == null) {</span>
<span class="nc" id="L662">            return 0;</span>
        }
<span class="fc" id="L664">        return solicitudes.size();</span>
    }
    @Override
    public boolean hasActiveRequests() {
<span class="pc bpc" id="L668" title="1 of 2 branches missed.">        if (solicitudes == null) {</span>
<span class="nc" id="L669">            return false;</span>
        }
<span class="pc bpc" id="L671" title="2 of 4 branches missed.">        return solicitudes.stream().anyMatch(s -&gt; s.getActualState() == RequestStateEnum.PENDIENTE || s.getActualState() == RequestStateEnum.EN_REVISION);</span>
    }


    @Override
    public RequestApprovalRateDTO getRequestApprovalRate() {
<span class="pc bpc" id="L677" title="1 of 4 branches missed.">        if (solicitudes == null || solicitudes.isEmpty()) {</span>
<span class="fc" id="L678">            return new RequestApprovalRateDTO(0, </span>
<span class="fc" id="L679">            0, 0,</span>
<span class="fc" id="L680">            0, 0);</span>
        }
<span class="fc" id="L682">        int totalRequests = getTotalRequestsMade();</span>
<span class="fc" id="L683">        int approvedRequests = getTotalApprovedRequests();</span>
<span class="fc" id="L684">        int rejectedRequests = getTotalRejectedRequests();</span>
<span class="fc" id="L685">        int pendingRequests = getTotalPendingRequests();</span>
<span class="fc" id="L686">        int inReviewRequests = getTotalInReviewRequests();</span>

<span class="fc" id="L688">        return new RequestApprovalRateDTO(</span>
<span class="fc" id="L689">            totalRequests,</span>
<span class="fc" id="L690">            approvedRequests,</span>
<span class="fc" id="L691">            rejectedRequests,</span>
<span class="fc" id="L692">            pendingRequests,</span>
<span class="fc" id="L693">            inReviewRequests</span>
        );
    }

    @Override
    public int getTotalApprovedRequests() {
<span class="pc bpc" id="L699" title="1 of 2 branches missed.">        if (solicitudes == null) {</span>
<span class="nc" id="L700">            return 0;</span>
        }
<span class="pc bpc" id="L702" title="1 of 2 branches missed.">        return (int) solicitudes.stream().filter(s -&gt; s.getActualState() == RequestStateEnum.APROBADA).count();</span>
    }

    @Override
    public int getTotalRejectedRequests() {
<span class="pc bpc" id="L707" title="1 of 2 branches missed.">        if (solicitudes == null) {</span>
<span class="nc" id="L708">            return 0;</span>
        }
<span class="pc bpc" id="L710" title="1 of 2 branches missed.">        return (int) solicitudes.stream().filter(s -&gt; s.getActualState() == RequestStateEnum.RECHAZADA).count();</span>
    }

    @Override
    public int getTotalPendingRequests() {
<span class="pc bpc" id="L715" title="1 of 2 branches missed.">        if (solicitudes == null) {</span>
<span class="nc" id="L716">            return 0;</span>
        }
<span class="pc bpc" id="L718" title="1 of 2 branches missed.">        return (int) solicitudes.stream().filter(s -&gt; s.getActualState() == RequestStateEnum.PENDIENTE).count();</span>
    }

    @Override
    public int getTotalInReviewRequests() {
<span class="pc bpc" id="L723" title="1 of 2 branches missed.">        if (solicitudes == null) {</span>
<span class="nc" id="L724">            return 0;</span>
        }
<span class="pc bpc" id="L726" title="1 of 2 branches missed.">        return (int) solicitudes.stream().filter(s -&gt; s.getActualState() == RequestStateEnum.EN_REVISION).count();</span>
    }
    @Override
    public int getSubjectsByColorCount(SemaforoColores color) {
<span class="nc bnc" id="L730" title="All 2 branches missed.">        if (academicProgress == null) {</span>
<span class="nc" id="L731">            return 0;</span>
        }
<span class="nc" id="L733">        return academicProgress.getSubjectsByColorCount(color);</span>
    }
    
    public BaseRequest getRequestById(String requestId) {
<span class="nc bnc" id="L737" title="All 4 branches missed.">        if (solicitudes == null || solicitudes.isEmpty()) {</span>
<span class="nc" id="L738">            return null;</span>
        }
<span class="nc" id="L740">        return solicitudes.stream()</span>
<span class="nc" id="L741">            .filter(s -&gt; s.getId().equals(requestId))</span>
<span class="nc" id="L742">            .findFirst()</span>
<span class="nc" id="L743">            .orElse(null);</span>
    }
    /*
     * Devuelve el historial de solicitudes resueltas: aprobadas o rechazadas.
     */
    public List&lt;BaseRequest&gt; getRequestsHistory() {
<span class="nc bnc" id="L749" title="All 2 branches missed.">        if (solicitudes == null) {</span>
<span class="nc" id="L750">            return new ArrayList&lt;&gt;();</span>
        }
<span class="nc" id="L752">        return solicitudes.stream()</span>
<span class="nc bnc" id="L753" title="All 4 branches missed.">            .filter(s -&gt; s.getActualState() == RequestStateEnum.APROBADA || s.getActualState() == RequestStateEnum.RECHAZADA)</span>
<span class="nc" id="L754">            .toList();</span>
    }

}
 
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>