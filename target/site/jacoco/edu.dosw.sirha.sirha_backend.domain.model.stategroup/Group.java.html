<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Group.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">SIRHA-BackEnd</a> &gt; <a href="index.source.html" class="el_package">edu.dosw.sirha.sirha_backend.domain.model.stategroup</a> &gt; <span class="el_source">Group.java</span></div><h1>Group.java</h1><pre class="source lang-java linenums">package edu.dosw.sirha.sirha_backend.domain.model.stategroup;

import java.util.*;
import org.springframework.data.annotation.Id;
import org.springframework.data.mongodb.core.mapping.Document;
import edu.dosw.sirha.sirha_backend.domain.model.AcademicPeriod;
import edu.dosw.sirha.sirha_backend.domain.model.Professor;
import edu.dosw.sirha.sirha_backend.domain.model.Schedule;
import edu.dosw.sirha.sirha_backend.domain.model.Student;
import edu.dosw.sirha.sirha_backend.domain.model.Subject;
import edu.dosw.sirha.sirha_backend.domain.port.GroupState;
import edu.dosw.sirha.sirha_backend.exception.ErrorCodeSirha;
import edu.dosw.sirha.sirha_backend.exception.SirhaException;

/**
 * Entidad del dominio que representa un grupo académico en el sistema SIRHA.
 *
 * Un grupo es una instancia específica de una materia en un semestre determinado,
 * con un profesor asignado, un aula, schedules específicos y una capacidad máxima
 * de estudiantes. Esta clase implementa el patrón State para manejar los diferentes
 * estados del grupo (Abierto, Cerrado, Lleno).
 *
 * Características principales:
 * - Gestión de capacidad y cupos disponibles
 * - Estado dinámico que controla las inscripciones (State Pattern)
 * - Lista de estudiantes inscritos
 * - Información del profesor y curso asignado
 * - Control de inscripciones duplicadas
 *
 * Estados del grupo:
 * - ABIERTO: Acepta nuevas inscripciones si hay cupos
 * - CERRADO: No acepta mas inscripciones
 * @see GroupState
 * @see Professor
 * @see Subject
 * @see Student
 */
@Document(collection = &quot;groups&quot;)
public class Group {
    @Id
    private String id;
    private String code;
    private int capacidad;
    private int inscritos;
    private GroupState estadoGrupo; // State Pattern
    private Professor profesor;
    private Subject curso;
    private List&lt;Schedule&gt; schedules;
    private String aula;
    private AcademicPeriod currentPeriod;
    private List&lt;Student&gt; estudiantes;


    /**
     * Constructor principal para crear un nuevo grupo académico.
     *
     * Inicializa el grupo con una capacidad específica y lo establece
     * en estado ABIERTO por defecto. La lista de estudiantes se inicializa vacía.
     * @throws SirhaException 
     */
<span class="fc" id="L61">    public Group(Subject subject,int capacidad, AcademicPeriod currentPeriod) throws SirhaException {</span>
<span class="fc bfc" id="L62" title="All 2 branches covered.">        if (capacidad &lt;= 0) {</span>
<span class="fc" id="L63">            throw SirhaException.of(ErrorCodeSirha.INVALID_CAPACITY_GROUP, &quot;La capacidad del grupo debe ser mayor a cero&quot;);</span>
        }
<span class="fc" id="L65">        curso = subject;</span>
<span class="fc" id="L66">        setCapacidad(capacidad);</span>
<span class="fc" id="L67">        setCode();</span>
<span class="fc" id="L68">        setCurrentPeriod(currentPeriod);</span>
<span class="fc" id="L69">        this.inscritos = 0;</span>
<span class="fc" id="L70">        this.estadoGrupo = new StatusOpen(); // Estado inicial: abierto</span>
<span class="fc" id="L71">        this.estudiantes = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L72">        schedules = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L73">        addToSubject();</span>
<span class="fc" id="L74">    }</span>
    void setEstadoGrupo(GroupState estado) throws SirhaException {
<span class="pc bpc" id="L76" title="1 of 2 branches missed.">        if (estado == null) {</span>
<span class="nc" id="L77">            throw SirhaException.of(ErrorCodeSirha.INVALID_ARGUMENT, &quot;El estado del grupo no puede ser null&quot;);</span>
        }
<span class="fc" id="L79">        this.estadoGrupo = estado;</span>
<span class="fc" id="L80">    }</span>
    private void addToSubject() {
<span class="fc" id="L82">        curso.addGroup(this);   </span>
<span class="fc" id="L83">    }</span>

    /**
     * Obtiene el estado actual del grupo.
     * @return estado actual del grupo, nunca null
     */
    public GroupState getGroupState() {
<span class="fc" id="L90">        return estadoGrupo;</span>
    }

    /**
     * Intenta inscribir un estudiante en el grupo.
     *
     * Delega la operación de inscripción al estado actual del grupo,
     * que determina si la inscripción es posible según las reglas específicas
     * de cada estado (abierto, cerrado, lleno).
     *
     * El estado se encarga de:
     * - Validar si se puede realizar la inscripción
     * - Actualizar la lista de estudiantes y contador
     * - Cambiar el estado del grupo si es necesario
     *
     * @param estudiante estudiante a inscribir en el grupo. No debe ser null.
     * @throws SirhaException 
     */
    public void inscribirEstudiante(Student estudiante) throws SirhaException {
<span class="fc bfc" id="L109" title="All 2 branches covered.">        if (estudiante == null) {</span>
<span class="fc" id="L110">            throw SirhaException.of(ErrorCodeSirha.INVALID_ARGUMENT, &quot;El estudiante no puede ser null&quot;);</span>
        }

<span class="fc" id="L113">        estadoGrupo.addStudent(this, estudiante);</span>
<span class="fc" id="L114">    }</span>
    private void setCode(){
<span class="fc" id="L116">        this.code = curso.getName().substring(0,3).toUpperCase() + &quot;-&quot; + (curso.getGroupCount() + 1);</span>
<span class="fc" id="L117">    }</span>

    /**
     * Calcula el número de cupos disponibles en el grupo.
     *
     * @return número de cupos libres (capacidad - inscritos).
     *         Retorna 0 si el grupo está lleno.
     */
    public int getCuposDisponibles() {
<span class="fc" id="L126">        return Math.max(0, capacidad - inscritos);</span>
    }

    /**
     * Agrega un estudiante directamente a la lista del grupo. Se usa internamente por los estados.
     *
     * Este método es utilizado internamente por los estados del grupo
     * para realizar la inscripción efectiva. Actualiza tanto la lista
     * de estudiantes como el contador de inscritos.
     *
     * Validaciones realizadas:
     * - Verifica que el estudiante no esté ya inscrito
     * - Mantiene consistencia entre la lista y el contador
     * @throws SirhaException 
     *
     */
    void addStudent(Student estudiante) throws SirhaException {
<span class="pc bpc" id="L143" title="1 of 2 branches missed.">        if (estudiante == null) {</span>
<span class="nc" id="L144">            throw SirhaException.of(ErrorCodeSirha.INVALID_ARGUMENT, &quot;El estudiante no puede ser null&quot;);</span>
        }

<span class="fc bfc" id="L147" title="All 2 branches covered.">        if (estudiantes.contains(estudiante)) {</span>
<span class="fc" id="L148">            throw SirhaException.of(ErrorCodeSirha.STUDENT_ALREADY_IN_GROUP);</span>
        }

<span class="fc" id="L151">        estudiantes.add(estudiante);</span>
<span class="fc" id="L152">        inscritos++;</span>
<span class="fc" id="L153">    }</span>

    /**
     * Remueve un estudiante del grupo. Se usa internamente por los estados.
     *
     * Elimina al estudiante de la lista y actualiza el contador.
     * Puede cambiar el estado del grupo si es necesario.
     * @throws SirhaException 
     */
    void removeStudent(Student estudiante) throws SirhaException {
<span class="pc bpc" id="L163" title="2 of 6 branches missed.">        if (!estudiantes.contains(estudiante) || estudiante == null || estudiante.hasSubject(curso)) {</span>
<span class="fc" id="L164">            throw SirhaException.of(ErrorCodeSirha.STUDENT_NOT_IN_GROUP);</span>
        }

<span class="fc" id="L167">        estudiantes.remove(estudiante);</span>
<span class="fc" id="L168">        inscritos--;</span>
  
<span class="fc" id="L170">    }</span>
    public boolean enrollStudent(Student estudiante) throws SirhaException {
<span class="fc" id="L172">        return estadoGrupo.addStudent(this, estudiante);</span>
    }
    public boolean unenrollStudent(Student student) throws SirhaException {
<span class="fc" id="L175">        return estadoGrupo.removeStudent(this, student);</span>
    }
    public String getCode() {
<span class="fc" id="L178">        return code;</span>
    }

    /**
     * Verifica si el grupo está lleno.
     * @return true si no hay cupos disponibles, false en caso contrario
     */
    public boolean isFull() {
<span class="fc bfc" id="L186" title="All 2 branches covered.">        return inscritos &gt;= capacidad;</span>
    }

    public boolean isOpen() {
<span class="fc" id="L190">        return estadoGrupo instanceof StatusOpen;</span>
    }

    /**
     * Verifica si un estudiante está inscrito en el grupo.
     * @param estudiante estudiante a verificar
     * @return true si está inscrito, false en caso contrario
     */
    public boolean contieneEstudiante(Student estudiante) {
<span class="fc bfc" id="L199" title="All 4 branches covered.">        return estudiante != null &amp;&amp; estudiantes.contains(estudiante);</span>
    }

    // Getters y Setters con documentación

    public String getId() {
<span class="fc" id="L205">        return id;</span>
    }

    public void setId(String id) {
<span class="fc" id="L209">        this.id = id;</span>
<span class="fc" id="L210">    }</span>
    public AcademicPeriod getCurrentPeriod() {
<span class="fc" id="L212">        return currentPeriod;</span>
    }
    public void setCurrentPeriod(AcademicPeriod currentPeriod) {
<span class="fc" id="L215">        this.currentPeriod = currentPeriod;</span>
<span class="fc" id="L216">    }</span>

    /**
     * Obtiene la capacidad máxima del grupo.
     * @return capacidad máxima de estudiantes
     */
    public int getCapacidad() {
<span class="fc" id="L223">        return capacidad;</span>
    }

    /**
     * Establece la capacidad máxima del grupo.
     * Solo debe modificarse si no hay estudiantes inscritos.
     *
     * @param capacidad nueva capacidad. Debe ser mayor a cero.
     * @throws SirhaException 
     */
    public void setCapacidad(int capacidad) throws SirhaException {
<span class="fc bfc" id="L234" title="All 2 branches covered.">        if (capacidad &lt;= 0) {</span>
<span class="fc" id="L235">            throw SirhaException.of(ErrorCodeSirha.INVALID_CAPACITY_GROUP, &quot;La capacidad debe ser mayor a cero&quot;);</span>
        }
<span class="fc" id="L237">        canEditGroup();</span>
<span class="pc bpc" id="L238" title="1 of 2 branches missed.">        if (capacidad &lt; inscritos) {</span>
<span class="nc" id="L239">            throw SirhaException.of(ErrorCodeSirha.INVALID_CAPACITY_GROUP, &quot;La nueva capacidad no puede ser menor que el número actual de inscritos&quot;);</span>
        }
<span class="fc" id="L241">        this.capacidad = capacidad;</span>
<span class="fc" id="L242">    }</span>

    /**
     * Obtiene el número de estudiantes inscritos.
     * @return número actual de inscritos
     */
    public int getInscritos() {
<span class="fc" id="L249">        return inscritos;</span>
    }

    public Professor getProfesor() {
<span class="fc" id="L253">        return profesor;</span>
    }

    public void setProfesor(Professor profesor) {
<span class="fc" id="L257">        this.profesor = profesor;</span>
<span class="fc" id="L258">    }</span>

    public Subject getCurso() {
<span class="fc" id="L261">        return curso;</span>
    }

    public void setCurso(Subject curso) {
<span class="fc" id="L265">        this.curso = curso;</span>
<span class="fc" id="L266">    }</span>

    public String getAula() {
<span class="fc" id="L269">        return aula;</span>
    }

    public void setAula(String aula) {
<span class="fc" id="L273">        this.aula = aula;</span>
<span class="fc" id="L274">    }</span>

    /**
     * Obtiene una copia de la lista de estudiantes inscritos.
     * @return lista inmutable de estudiantes para evitar modificaciones externas
     */
    public List&lt;Student&gt; getEstudiantes() {
<span class="fc" id="L281">        return Collections.unmodifiableList(estudiantes);</span>
    }

    /**
     * Compara este grupo con otro objeto para determinar igualdad.
     * Dos grupos son iguales si tienen el mismo ID.
     */
    @Override
    public boolean equals(Object obj) {
<span class="fc bfc" id="L290" title="All 2 branches covered.">        if (this == obj) return true;</span>
<span class="pc bpc" id="L291" title="2 of 4 branches missed.">        if (obj == null || getClass() != obj.getClass()) return false;</span>

<span class="fc" id="L293">        Group group = (Group) obj;</span>
<span class="fc bfc" id="L294" title="All 2 branches covered.">        return Objects.equals(currentPeriod, group.currentPeriod)</span>
<span class="fc bfc" id="L295" title="All 2 branches covered.">                &amp;&amp; Objects.equals(code, group.code)</span>
<span class="pc bpc" id="L296" title="1 of 2 branches missed.">                &amp;&amp; Objects.equals(curso, group.curso)</span>
<span class="pc bpc" id="L297" title="1 of 2 branches missed.">                &amp;&amp; Objects.equals(profesor, group.profesor)</span>
<span class="pc bpc" id="L298" title="1 of 2 branches missed.">                &amp;&amp; Objects.equals(aula, group.aula)</span>
<span class="pc bpc" id="L299" title="1 of 2 branches missed.">                &amp;&amp; Objects.equals(schedules, group.schedules);</span>
    }

    @Override
    public int hashCode() {
<span class="fc" id="L304">        return Objects.hash(currentPeriod, code, curso, profesor, aula, schedules);</span>
    }

    @Override
    public String toString() {
<span class="fc" id="L309">        return String.format(&quot;Group{id='%s', capacidad=%d, inscritos=%d, aula='%s', estado=%s}&quot;,</span>
<span class="fc" id="L310">                id, capacidad, inscritos, aula,</span>
<span class="pc bpc" id="L311" title="1 of 2 branches missed.">                estadoGrupo != null ? estadoGrupo.getClass().getSimpleName() : &quot;null&quot;);</span>
    }
    public void removeGroup(){
<span class="fc" id="L314">        curso = null;</span>
<span class="fc" id="L315">    }</span>

    public void addSchedule(Schedule horario) throws SirhaException {
<span class="fc" id="L318">        canEditGroup();</span>
<span class="pc bpc" id="L319" title="1 of 2 branches missed.">        for (Schedule existente : schedules) {</span>
<span class="nc bnc" id="L320" title="All 2 branches missed.">            if (existente.seSolapaCon(horario)) {</span>
<span class="nc" id="L321">                throw SirhaException.of(ErrorCodeSirha.SCHEDULE_CONFLICT);</span>
            }
        }
<span class="fc" id="L324">        schedules.add(horario);</span>
<span class="fc" id="L325">    }</span>

    public boolean canEditGroup() throws SirhaException {
<span class="fc bfc" id="L328" title="All 2 branches covered.">        if (inscritos != 0) {</span>
<span class="fc" id="L329">            throw SirhaException.of(ErrorCodeSirha.OPERATION_NOT_ALLOWED, &quot;No se puede modificar el grupo con estudiantes inscritos&quot;);</span>
        }
<span class="pc bpc" id="L331" title="1 of 2 branches missed.">        return inscritos == 0;</span>
    }

    public List&lt;Schedule&gt; getSchedules() {
<span class="fc" id="L335">        return schedules;</span>
    }

    public boolean conflictoConHorario(Schedule horario) {
<span class="fc bfc" id="L339" title="All 2 branches covered.">        for (Schedule existente : schedules) {</span>
<span class="fc bfc" id="L340" title="All 2 branches covered.">            if (existente.seSolapaCon(horario)) {</span>
<span class="fc" id="L341">                return true;</span>
            }
        }
<span class="fc" id="L344">        return false;</span>
    }


    public boolean conflictoConHorario(Group otroGrupo){
<span class="pc bpc" id="L349" title="2 of 4 branches missed.">        if (otroGrupo == null || otroGrupo.getSchedules() == null) {</span>
<span class="nc" id="L350">            return false;</span>
        }
<span class="fc bfc" id="L352" title="All 2 branches covered.">        for (Schedule horarioOtro : otroGrupo.getSchedules()) {</span>
<span class="fc bfc" id="L353" title="All 2 branches covered.">            if (conflictoConHorario(horarioOtro)) {</span>
<span class="fc" id="L354">                return true;</span>
            }
        }
<span class="fc" id="L357">        return false;</span>
    }

    public void closeGroup() throws SirhaException {
<span class="fc" id="L361">        setEstadoGrupo(new StatusClosed());</span>
<span class="fc" id="L362">    }</span>
    public void openGroup() throws SirhaException {
<span class="nc" id="L364">        setEstadoGrupo(new StatusOpen());</span>
<span class="nc" id="L365">    }</span>
    public boolean sameAcademicPeriod(AcademicPeriod period){
<span class="fc" id="L367">        return this.currentPeriod.equals(period);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>