<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GlobalExceptionHandler.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">SIRHA-BackEnd</a> &gt; <a href="index.source.html" class="el_package">edu.dosw.sirha.sirha_backend.infrastructure.handler</a> &gt; <span class="el_source">GlobalExceptionHandler.java</span></div><h1>GlobalExceptionHandler.java</h1><pre class="source lang-java linenums">package edu.dosw.sirha.sirha_backend.infrastructure.handler;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;

import edu.dosw.sirha.sirha_backend.dto.ApiErrorResponse;
import edu.dosw.sirha.sirha_backend.exception.SirhaException;
import jakarta.servlet.http.HttpServletRequest;

@RestControllerAdvice
<span class="fc" id="L15">public class GlobalExceptionHandler {</span>

<span class="fc" id="L17">    private static final Logger log = LoggerFactory.getLogger(GlobalExceptionHandler.class);</span>

    /**
     * Maneja todas las excepciones SirhaException (checked exceptions del dominio)
     */
    @ExceptionHandler(SirhaException.class)
    public ResponseEntity&lt;ApiErrorResponse&gt; handleSirhaException(SirhaException ex, HttpServletRequest request) {
<span class="nc" id="L24">        log.error(&quot;SIRHA exception: {} - {}&quot;, ex.getCode(), ex.getMessage());</span>

<span class="nc" id="L26">        HttpStatus status = determineHttpStatus(ex.getCode());</span>

<span class="nc" id="L28">        ApiErrorResponse error = new ApiErrorResponse(</span>
            status,
<span class="nc" id="L30">            ex.getCode(),</span>
<span class="nc" id="L31">            ex.getMessage(),</span>
            &quot;Error de lógica de negocio en SIRHA.&quot;,
<span class="nc" id="L33">            request.getRequestURI()</span>
        );

<span class="nc" id="L36">        addSuggestion(error, ex.getCode());</span>
<span class="nc" id="L37">        return new ResponseEntity&lt;&gt;(error, status);</span>
    }

    /**
     * Maneja RuntimeExceptions que pueden envolver SirhaExceptions
     */
    @ExceptionHandler(RuntimeException.class)
    public ResponseEntity&lt;ApiErrorResponse&gt; handleRuntimeException(RuntimeException ex, HttpServletRequest request) {
        
        // Verificar si es una SirhaException envuelta
<span class="nc bnc" id="L47" title="All 2 branches missed.">        if (ex.getCause() instanceof SirhaException sirhaEx) {</span>
<span class="nc" id="L48">            log.error(&quot;Wrapped SIRHA exception: {} - {}&quot;, sirhaEx.getCode(), sirhaEx.getMessage());</span>
            
<span class="nc" id="L50">            HttpStatus status = determineHttpStatus(sirhaEx.getCode());</span>
            
<span class="nc" id="L52">            ApiErrorResponse error = new ApiErrorResponse(</span>
                status,
<span class="nc" id="L54">                sirhaEx.getCode(),</span>
<span class="nc" id="L55">                sirhaEx.getMessage(),</span>
                &quot;Error de lógica de negocio en SIRHA.&quot;,
<span class="nc" id="L57">                request.getRequestURI()</span>
            );
            
<span class="nc" id="L60">            addSuggestion(error, sirhaEx.getCode());</span>
<span class="nc" id="L61">            return new ResponseEntity&lt;&gt;(error, status);</span>
        }
        
        // Manejar otras RuntimeExceptions
<span class="nc" id="L65">        log.error(&quot;Runtime exception: {}&quot;, ex.getMessage(), ex);</span>
        
<span class="nc" id="L67">        ApiErrorResponse error = new ApiErrorResponse(</span>
            HttpStatus.INTERNAL_SERVER_ERROR,
            &quot;INTERNAL_ERROR&quot;,
            &quot;Ha ocurrido un error interno en el servidor.&quot;,
<span class="nc" id="L71">            ex.getMessage(),</span>
<span class="nc" id="L72">            request.getRequestURI()</span>
        );
        
<span class="nc" id="L75">        error.setSuggestion(&quot;Intente nuevamente más tarde o contacte soporte técnico.&quot;);</span>
<span class="nc" id="L76">        return new ResponseEntity&lt;&gt;(error, HttpStatus.INTERNAL_SERVER_ERROR);</span>
    }

    /**
     * Maneja IllegalArgumentException
     */
    @ExceptionHandler(IllegalArgumentException.class)
    public ResponseEntity&lt;ApiErrorResponse&gt; handleIllegalArgumentException(IllegalArgumentException ex, HttpServletRequest request) {
<span class="nc" id="L84">        log.warn(&quot;Illegal argument exception: {}&quot;, ex.getMessage());</span>

<span class="nc" id="L86">        ApiErrorResponse error = new ApiErrorResponse(</span>
            HttpStatus.BAD_REQUEST,
            &quot;INVALID_ARGUMENT&quot;,
<span class="nc" id="L89">            ex.getMessage(),</span>
            &quot;Los datos proporcionados no son válidos.&quot;,
<span class="nc" id="L91">            request.getRequestURI()</span>
        );

<span class="nc" id="L94">        error.setSuggestion(&quot;Verifique los parámetros enviados en la solicitud.&quot;);</span>
<span class="nc" id="L95">        return new ResponseEntity&lt;&gt;(error, HttpStatus.BAD_REQUEST);</span>
    }

    /**
     * Maneja excepciones genéricas no capturadas por otros handlers
     */
    @ExceptionHandler(Exception.class)
    public ResponseEntity&lt;ApiErrorResponse&gt; handleGeneralException(Exception ex, HttpServletRequest request) {
        
        // Verificar si es una SirhaException envuelta en Exception
<span class="nc bnc" id="L105" title="All 2 branches missed.">        if (ex.getCause() instanceof SirhaException sirhaEx) {</span>
<span class="nc" id="L106">            log.error(&quot;Exception wrapping SIRHA exception: {} - {}&quot;, sirhaEx.getCode(), sirhaEx.getMessage());</span>
            
<span class="nc" id="L108">            HttpStatus status = determineHttpStatus(sirhaEx.getCode());</span>
            
<span class="nc" id="L110">            ApiErrorResponse error = new ApiErrorResponse(</span>
                status,
<span class="nc" id="L112">                sirhaEx.getCode(),</span>
<span class="nc" id="L113">                sirhaEx.getMessage(),</span>
                &quot;Error de lógica de negocio en SIRHA.&quot;,
<span class="nc" id="L115">                request.getRequestURI()</span>
            );
            
<span class="nc" id="L118">            addSuggestion(error, sirhaEx.getCode());</span>
<span class="nc" id="L119">            return new ResponseEntity&lt;&gt;(error, status);</span>
        }
        
        // Manejar excepciones completamente inesperadas
<span class="nc" id="L123">        log.error(&quot;Unexpected exception&quot;, ex);</span>

<span class="nc" id="L125">        ApiErrorResponse error = new ApiErrorResponse(</span>
            HttpStatus.INTERNAL_SERVER_ERROR,
            &quot;UNEXPECTED_ERROR&quot;,
            &quot;Ha ocurrido un error inesperado en el servidor.&quot;,
<span class="nc" id="L129">            ex.getMessage(),</span>
<span class="nc" id="L130">            request.getRequestURI()</span>
        );

<span class="nc" id="L133">        error.setSuggestion(&quot;Intente nuevamente más tarde o contacte soporte técnico.&quot;);</span>
<span class="nc" id="L134">        return new ResponseEntity&lt;&gt;(error, HttpStatus.INTERNAL_SERVER_ERROR);</span>
    }

    /**
     * Determina el HttpStatus basado en el código de error
     */
    private HttpStatus determineHttpStatus(String errorCode) {
<span class="nc bnc" id="L141" title="All 7 branches missed.">        return switch (errorCode) {</span>
            // 404 Not Found - Recursos no encontrados
            case &quot;STUDENT_NOT_FOUND&quot;, &quot;SUBJECT_NOT_FOUND&quot;, &quot;GROUP_NOT_FOUND&quot;, 
                 &quot;REQUEST_NOT_FOUND&quot;, &quot;ACADEMIC_PERIOD_NOT_FOUND&quot; -&gt; 
<span class="nc" id="L145">                HttpStatus.NOT_FOUND;</span>
            
            // 409 Conflict - Conflictos de estado o datos
            case &quot;REQUEST_ALREADY_APPROVED&quot;, &quot;REQUEST_ALREADY_REJECTED&quot;, &quot;REQUEST_ALREADY_PENDING&quot;,
                 &quot;REQUEST_ALREADY_IN_REVIEW&quot;, &quot;INVALID_STATE_TRANSITION&quot;, &quot;EMAIL_ALREADY_EXISTS&quot;,
                 &quot;CODE_ALREADY_EXISTS&quot;, &quot;USERNAME_ALREADY_EXISTS&quot;, &quot;DUPLICATE_REQUEST&quot;,
                 &quot;SCHEDULE_CONFLICT&quot; -&gt; 
<span class="nc" id="L152">                HttpStatus.CONFLICT;</span>
            
            // 400 Bad Request - Datos inválidos o errores de validación
            case &quot;INVALID_CREDENTIALS&quot;, &quot;VALIDATION_ERROR&quot;, &quot;INVALID_ARGUMENT&quot;, 
                 &quot;MISSING_REQUIRED_FIELD&quot;, &quot;REQUEST_NOT_IN_REVIEW&quot; -&gt; 
<span class="nc" id="L157">                HttpStatus.BAD_REQUEST;</span>
            
            // 403 Forbidden - Permisos insuficientes
            case &quot;INSUFFICIENT_PERMISSIONS&quot;, &quot;OPERATION_NOT_ALLOWED&quot; -&gt; 
<span class="nc" id="L161">                HttpStatus.FORBIDDEN;</span>
            
            // 502 Bad Gateway - Errores de servicios externos
            case &quot;EXTERNAL_SERVICE_ERROR&quot; -&gt; 
<span class="nc" id="L165">                HttpStatus.BAD_GATEWAY;</span>
            
            // 500 Internal Server Error - Errores del sistema
            case &quot;INTERNAL_ERROR&quot;, &quot;DATABASE_ERROR&quot; -&gt; 
<span class="nc" id="L169">                HttpStatus.INTERNAL_SERVER_ERROR;</span>
            
            // Default para códigos no reconocidos
            default -&gt; {
<span class="nc" id="L173">                log.warn(&quot;Unrecognized error code: {}, defaulting to INTERNAL_SERVER_ERROR&quot;, errorCode);</span>
<span class="nc" id="L174">                yield HttpStatus.INTERNAL_SERVER_ERROR;</span>
            }
        };
    }

    /**
     * Añade sugerencias específicas basadas en el código de error
     */
    private void addSuggestion(ApiErrorResponse error, String code) {
<span class="nc bnc" id="L183" title="All 17 branches missed.">        String suggestion = switch (code) {</span>
            // Errores de recursos no encontrados
            case &quot;STUDENT_NOT_FOUND&quot;, &quot;SUBJECT_NOT_FOUND&quot;, &quot;GROUP_NOT_FOUND&quot;, 
                 &quot;REQUEST_NOT_FOUND&quot;, &quot;ACADEMIC_PERIOD_NOT_FOUND&quot; -&gt; 
<span class="nc" id="L187">                &quot;Verifique que el recurso existe y los parámetros son correctos.&quot;;</span>
            
            // Errores de transición de estado
            case &quot;REQUEST_ALREADY_APPROVED&quot; -&gt; 
<span class="nc" id="L191">                &quot;Esta solicitud ya fue aprobada previamente. No se requiere acción adicional.&quot;;</span>
                
            case &quot;REQUEST_ALREADY_REJECTED&quot; -&gt; 
<span class="nc" id="L194">                &quot;Esta solicitud ya fue rechazada. Puede crear una nueva solicitud si es necesario.&quot;;</span>
                
            case &quot;INVALID_STATE_TRANSITION&quot; -&gt; 
<span class="nc" id="L197">                &quot;La transición de estado solicitada no es válida para el estado actual de la solicitud.&quot;;</span>
            
            // Errores de conflictos de datos
            case &quot;EMAIL_ALREADY_EXISTS&quot; -&gt; 
<span class="nc" id="L201">                &quot;Use un email diferente que no esté registrado en el sistema.&quot;;</span>
                
            case &quot;CODE_ALREADY_EXISTS&quot; -&gt; 
<span class="nc" id="L204">                &quot;Use un código estudiantil diferente que no esté registrado.&quot;;</span>
                
            case &quot;USERNAME_ALREADY_EXISTS&quot; -&gt; 
<span class="nc" id="L207">                &quot;Elija un nombre de usuario diferente que esté disponible.&quot;;</span>
                
            case &quot;DUPLICATE_REQUEST&quot; -&gt; 
<span class="nc" id="L210">                &quot;Ya existe una solicitud similar. Revise sus solicitudes pendientes.&quot;;</span>
            
            // Errores de validación
            case &quot;INVALID_CREDENTIALS&quot; -&gt; 
<span class="nc" id="L214">                &quot;Verifique que su usuario y contraseña sean correctos.&quot;;</span>
                
            case &quot;VALIDATION_ERROR&quot;, &quot;INVALID_ARGUMENT&quot; -&gt; 
<span class="nc" id="L217">                &quot;Revise que todos los campos estén correctamente completados.&quot;;</span>
                
            case &quot;MISSING_REQUIRED_FIELD&quot; -&gt; 
<span class="nc" id="L220">                &quot;Complete todos los campos obligatorios antes de continuar.&quot;;</span>
            
            // Errores de permisos
            case &quot;INSUFFICIENT_PERMISSIONS&quot; -&gt; 
<span class="nc" id="L224">                &quot;Contacte al administrador del sistema para obtener los permisos necesarios.&quot;;</span>
                
            case &quot;OPERATION_NOT_ALLOWED&quot; -&gt; 
<span class="nc" id="L227">                &quot;Esta operación no está permitida en las circunstancias actuales.&quot;;</span>
            
            // Errores de horarios
            case &quot;SCHEDULE_CONFLICT&quot; -&gt; 
<span class="nc" id="L231">                &quot;Existe un conflicto de horarios. Seleccione un horario diferente.&quot;;</span>
            
            // Errores técnicos
            case &quot;EXTERNAL_SERVICE_ERROR&quot; -&gt; 
<span class="nc" id="L235">                &quot;Problema con un servicio externo. Intente nuevamente en unos minutos.&quot;;</span>
                
            case &quot;DATABASE_ERROR&quot; -&gt; 
<span class="nc" id="L238">                &quot;Error de base de datos. Contacte soporte técnico si persiste.&quot;;</span>
            
            // Default
<span class="nc" id="L241">            default -&gt; &quot;Consulte la documentación de la API para más información.&quot;;</span>
        };
<span class="nc" id="L243">        error.setSuggestion(suggestion);</span>
<span class="nc" id="L244">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>